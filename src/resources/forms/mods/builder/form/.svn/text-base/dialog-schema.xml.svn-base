<?xml version="1.0" encoding="UTF-8"?>
<!--
    Copyright (C) 2008 Orbeon, Inc.

    This program is free software; you can redistribute it and/or modify it under the terms of the
    GNU Lesser General Public License as published by the Free Software Foundation; either version
    2.1 of the License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
    without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
    See the GNU Lesser General Public License for more details.

    The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
-->
<xxforms:dialog xmlns:xhtml="http://www.w3.org/1999/xhtml"
      xmlns:xforms="http://www.w3.org/2002/xforms"
      xmlns:xs="http://www.w3.org/2001/XMLSchema"
      xmlns:ev="http://www.w3.org/2001/xml-events"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
      xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
      xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
      xmlns:saxon="http://saxon.sf.net/"

      id="fb-schema-upload-dialog" level="modal" class="fr-dialog">

    <xforms:label>XML Schema Upload</xforms:label>
    <xxforms:variable name="instance" select="instance('fb-schema-upload-instance')"/>
    <xhtml:div>
        <xforms:group>

            <!-- Schema information -->
            <xxforms:variable name="schema-element" select="($instance/schema/xs:schema, $model/xs:schema)[1]"/>
            <xxforms:variable name="is-existing-schema" select="exists($model/xs:schema)"/>
            <xxforms:variable name="is-new-schema" select="exists($instance/schema/xs:schema)"/>

            <xforms:group ref="$schema-element" class="fb-hide-alert">
                <xforms:label class="fb-dialog-h2" value="if ($is-new-schema) then 'New Schema Information' else 'Existing Schema Information'"/>

                <xhtml:div class="fb-dialog-section">
                    <xforms:group ref=".[xs:simpleType]">
                        <!-- Schema types -->
                        <xforms:select1 ref="$instance/temp-type" appearance="compact">
                            <xforms:label>Available Schema Types</xforms:label>
                            <xforms:hint>This lists the simple types available in the uploaded schema</xforms:hint>
                            <!--<xforms:item>-->
                                <!--<xforms:label>[Select...]</xforms:label>-->
                                <!--<xforms:value/>-->
                            <!--</xforms:item>-->
                            <xforms:itemset nodeset="$schema-element/xs:simpleType">
                                <xforms:label ref="@name"/>
                                <xforms:value ref="@name"/>
                            </xforms:itemset>
                        </xforms:select1>
                    </xforms:group>
                    <xforms:group ref=".[not(xs:simpleType)]">
                        <xforms:label>Available Schema Types</xforms:label>
                        Your schema does not seem to contain simple types. You won't be able to select types
                        from this schema for validation.
                    </xforms:group>
                    <xforms:group ref=".[@targetNamespace]">
                        <xforms:output value="@targetNamespace">
                            <xforms:label>Schema Namespace URI</xforms:label>
                            <xforms:hint>This is the namespace URI of the uploaded schema</xforms:hint>
                        </xforms:output>
                    </xforms:group>
                </xhtml:div>

            </xforms:group>
            <xforms:group class="fb-hide-alert">
                <xforms:label class="fb-dialog-h2">Operations</xforms:label>

                <xhtml:div class="fb-dialog-section">
                    <xforms:trigger ref=".[not($is-new-schema) and $model/xs:schema]">
                        <xforms:label>Delete Existing XML Schema</xforms:label>

                        <xforms:action ev:event="DOMActivate">
                            <!-- Delete XML Schema -->
                            <xforms:delete nodeset="$model/xs:schema"/>
                            <!-- TODO: Ask for confirmation, esp. if some types are in use -->
                            <!-- TODO: Check and adjust types that could be in use -->
                        </xforms:action>

                    </xforms:trigger>

                    <!-- Upload a schema -->
                    <xforms:upload ref="$instance/schema-uri">
                        <xforms:label value="if ($is-new-schema) then 'Change XML Schema' else if ($is-existing-schema) then 'Replace XML Schema' else 'Upload XML Schema'"/>
                        <xforms:filename ref="@filename"/>
                        <xforms:mediatype ref="@mediatype"/>
                        <xxforms:size ref="@size"/>

                        <!-- Upload file when selected -->
                        <xforms:action ev:event="xforms-select">
                            <xforms:send submission="fb-schema-upload-submission"/>
                        </xforms:action>

                        <!-- Handle a successful submission -->
                        <xforms:action ev:event="xforms-submit-done" ev:observer="fb-schema-upload-submission" context="$instance">
                            <!-- Read the schema and store it -->
                            <!-- TODO: support catching dynamic XPath error in case doc() fails -->
                            <xforms:insert context="schema" origin="doc(../schema-uri)"/>
                            <xxforms:variable name="schema-element" select="schema/*"/>
                            <xforms:action if="$schema-element/self::xs:schema">
                                <!-- We got something that looks like a schema -->

                                <!-- Check for inclusions -->
                                <xforms:action if="$schema-element/(xs:import | xs:include)">
                                    <xforms:message>Your schema contains imports or includes. These will be disabled.</xforms:message>
                                    <!-- Delete inclusions -->
                                    <xforms:delete nodeset="$schema-element/(xs:import | xs:include)"/>
                                </xforms:action>

                            </xforms:action>
                            <xforms:action if="not($schema-element/self::xs:schema)">
                                <!-- Oops, this is definitely not a schema -->
                                <xforms:message>The uploaded file is not a valid schema.</xforms:message>
                                <!-- Clear uploaded content -->
                                <xforms:setvalue ref="schema-uri"/>
                                <xforms:delete nodeset="$schema-element"/>
                            </xforms:action>
                        </xforms:action>

                        <!-- Clear information when deselected -->
                        <xforms:action ev:event="xforms-deselect">
                            <!-- Clear uploaded content -->
                            <xforms:setvalue ref="$instance/schema-uri"/>
                            <xforms:delete nodeset="$instance/schema/*"/>
                        </xforms:action>
                    </xforms:upload>
                </xhtml:div>
            </xforms:group>

        </xforms:group>
    </xhtml:div>
    <xhtml:div class="fr-dialog-buttons">
        <xforms:group appearance="xxforms:internal">
            <xforms:trigger class="fr-inplace-rename" id="fb-edit-schema-trigger">
                <xforms:label>Apply</xforms:label>

                <xforms:action ev:event="DOMActivate">
                    <!-- Insert schema into the model -->

                    <!-- Delete existing XML Schema if any -->
                    <!-- TODO: What we want in fact is to disable this button if there is an existing schema, and the user will explicitly remove the previous schema -->
                    <xforms:delete nodeset="$model/xs:schema"/>

                    <xforms:insert context="$model" origin="$instance/schema/*"/>
                </xforms:action>

            </xforms:trigger>
            or
            <xforms:trigger appearance="minimal" class="fr-inplace-cancel">
                <xforms:label>Cancel</xforms:label>
            </xforms:trigger>

            <xforms:action ev:event="DOMActivate">
                <!-- Hide dialog -->
                <xxforms:hide dialog="fb-schema-upload-dialog"/>
                <!-- Clear uploaded content -->
                <xforms:setvalue ref="$instance/schema-uri"/>
                <xforms:delete nodeset="$instance/schema/*"/>
            </xforms:action>
        </xforms:group>
    </xhtml:div>
</xxforms:dialog>