<?xml version="1.0" encoding="UTF-8"?>
<!--
    Copyright (C) 2008 Orbeon, Inc.

    This program is free software; you can redistribute it and/or modify it under the terms of the
    GNU Lesser General Public License as published by the Free Software Foundation; either version
    2.1 of the License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
    without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
    See the GNU Lesser General Public License for more details.

    The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
-->
<xxforms:dialog xmlns:xhtml="http://www.w3.org/1999/xhtml"
      xmlns:xforms="http://www.w3.org/2002/xforms"
      xmlns:xs="http://www.w3.org/2001/XMLSchema"
      xmlns:ev="http://www.w3.org/2001/xml-events"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
      xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
      xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
      xmlns:saxon="http://saxon.sf.net/"

      id="fb-edit-validation-dialog" appearance="minimal" model="fb-validation-model" level="modal">

    <xforms:label>Edit Validation Properties</xforms:label>
    <xxforms:variable name="instance" select="instance('fb-validation-editor-instance')"/>
    <xhtml:div>
        <xhtml:div class="fr-grid">
            <xhtml:div class="fr-grid-content">

                <xforms:group appearance="xxforms:fieldset">
                    <xforms:label>Types</xforms:label>
                    <xforms:select1 ref="builtin-type">
                        <xforms:label>Built-in Type</xforms:label>
                        <xforms:hint>Built-in data type</xforms:hint>
                        <xforms:itemset nodeset="instance('fb-validation-types-instance')/root()//(choices | type)">
                            <xforms:label ref="if (self::choices) then label else if (label) then label else ."/>
                            <xforms:value ref="if (self::choices) then () else if (value) then value else ."/>
                        </xforms:itemset>
                        <xforms:setvalue ev:event="xforms-value-changed" if=". != ''" ref="../schema-type"/>
                    </xforms:select1>

                    <!-- Schema type selection if applicable -->
                    <xforms:select1 ref="schema-type[$model/xs:schema]">
                        <xforms:label>
                            <xhtml:img src="/forms/orbeon/builder/images/schema.gif" alt="" title=""/>
                            <xhtml:span>Schema Type</xhtml:span>
                        </xforms:label>
                        <xforms:hint>Imported schema type</xforms:hint>
                        <xforms:item>
                            <xforms:label>[Select...]</xforms:label>
                            <xforms:value/>
                        </xforms:item>
                        <xforms:itemset nodeset="$model/xs:schema/xs:simpleType">
                            <xforms:label ref="@name"/>
                            <xforms:value ref="@name"/>
                        </xforms:itemset>
                        <xforms:setvalue ev:event="xforms-value-changed" if=". != ''" ref="../builtin-type"/>
                    </xforms:select1>

                    <xforms:select1 ref="required" appearance="full">
                        <xforms:label>Required</xforms:label>
                        <xforms:hint>Whether the data is required</xforms:hint>
                        <xforms:item>
                            <xforms:label>Yes</xforms:label>
                            <xforms:value>true</xforms:value>
                        </xforms:item>
                        <xforms:item>
                            <xforms:label>No</xforms:label>
                            <xforms:value>false</xforms:value>
                        </xforms:item>
                    </xforms:select1>
                </xforms:group>

                <!-- TODO: expression for @constraint + figure out how to deal w/ max length etc. -->

                <!-- TODO: expression for @required -->

                <xforms:group appearance="xxforms:fieldset">
                    <xforms:label>Expressions</xforms:label>
                    <!--<xforms:help>-->
                        <!--<xhtml:div>-->
                            <!--Foobar-->
                        <!--</xhtml:div>-->
                    <!--</xforms:help>-->
                    <xforms:input ref="constraint" incremental="true">
                        <xforms:label>
                            <xhtml:img src="/apps/fr/style/images/silk/link.png" alt="" title=""/>
                            <xhtml:span>Constraint</xhtml:span>
                        </xforms:label>
                        <xforms:alert>Incorrect XPath expression</xforms:alert>
                        <xforms:hint>Boolean XPath expression</xforms:hint>
                    </xforms:input>

                    <xforms:input ref="relevant" incremental="true">
                        <xforms:label>
                            <xhtml:img src="/apps/fr/style/images/silk/eye.png" alt="" title=""/>
                            <xhtml:span>Visibility</xhtml:span>
                        </xforms:label>
                        <xforms:alert>Incorrect XPath expression</xforms:alert>
                        <xforms:hint>Boolean XPath expression</xforms:hint>
                    </xforms:input>

                    <xforms:input ref="readonly" incremental="true">
                        <xforms:label>
                            <xhtml:img src="/apps/fr/style/images/silk/key.png" alt="" title=""/>
                            <xhtml:span>Read-Only</xhtml:span>
                        </xforms:label>
                        <xforms:alert>Incorrect XPath expression</xforms:alert>
                        <xforms:hint>Boolean XPath expression</xforms:hint>
                    </xforms:input>

                    <xforms:input ref="default" incremental="true">
                        <xforms:label>
                            <xhtml:img src="/apps/fr/style/images/silk/flag_yellow.png" alt="" title=""/>
                            <xhtml:span>Initial Value</xhtml:span>
                        </xforms:label>
                        <xforms:hint>XPath expression</xforms:hint>
                    </xforms:input>

                    <xforms:input ref="calculate" incremental="true">
                        <xforms:label>
                            <xhtml:img src="/apps/fr/style/images/silk/calculator_edit.png" alt="" title=""/>
                            <xhtml:span>Calculated Value</xhtml:span>
                        </xforms:label>
                        <xforms:hint>XPath expression</xforms:hint>
                    </xforms:input>
                </xforms:group>

                <!-- Alert message -->
                <xforms:textarea ref="alert" incremental="true">
                    <xforms:label>
                        <xhtml:img src="/apps/fr/style/images/silk/exclamation.png" alt="" title=""/>
                        <xhtml:span>Alert Message</xhtml:span>
                    </xforms:label>
                    <xforms:label>Alert Message</xforms:label>
                    <xforms:hint>Message to display when the data is incorrect</xforms:hint>
                </xforms:textarea>
            </xhtml:div>
        </xhtml:div>

        <xhtml:div class="fr-dialog-buttons">
                <xforms:trigger ref="save-trigger" class="fr-inplace-rename">
                <xforms:label>Apply</xforms:label>
                <!-- Close and save upon DOMActivate -->
                <xforms:dispatch ev:event="DOMActivate" name="xxforms-dialog-close" target="fb-edit-validation-dialog"/>
            </xforms:trigger>
            or
            <xforms:trigger appearance="minimal" class="fr-inplace-cancel">
                <xforms:label>Cancel</xforms:label>
                <!-- Close and cancel upon DOMActivate -->
                <xforms:dispatch ev:event="DOMActivate" name="xxforms-dialog-close" target="fb-edit-validation-dialog">
                    <xxforms:context name="fb:save" select="false()"/>
                </xforms:dispatch>
            </xforms:trigger>
        </xhtml:div>
    </xhtml:div>

    <!-- Save data upon close, unless explicitly prevented or unless the sub-form is not valid -->
    <xforms:action ev:event="xxforms-dialog-close" if="not(event('fb:save') = false()) and instance('fb-validation-editor-instance')/save-trigger = 'enabled'">
        <xxforms:variable name="instance" select="instance('fb-validation-editor-instance')"/>
        <xxforms:variable name="current-control" select="if ($current-control-name != '') then $body//*[@id = concat($current-control-name, '-control')] else ()"/>
        <xxforms:variable name="current-control-resource" select="$current-resources/*[name() = $current-control-name]"/>
        <xxforms:variable name="current-bind-id" select="concat($current-control-name, '-bind')"/>

        <!-- Copy back the alert -->
        <xforms:setvalue ref="$current-control-resource/alert" value="$instance/alert"/>
        <!-- Switch between default alert message and user-specified alert message as needed -->
        <xforms:setvalue if="normalize-space($instance/alert) != ''" ref="$current-control/xforms:alert/@ref" value="concat('$form-resources/', $current-control-name, '/alert')"/>
        <xforms:setvalue if="normalize-space($instance/alert) = ''" ref="$current-control/xforms:alert/@ref" value="'$fr-resources/detail/labels/alert'"/>

        <xforms:action>

            <!-- Insert bind if needed -->
            <xforms:dispatch name="fb-ensure-bind" target="fr-form-model">
                <xxforms:context name="control-name" select="$current-control-name"/>
            </xforms:dispatch>

            <!-- Make sure the control points to the bind -->
            <xforms:action context="$current-control">
                <xforms:delete nodeset="@ref"/>
                <xforms:insert context="." origin="xxforms:attribute('bind', $current-bind-id)"/>
            </xforms:action>

            <xxforms:variable name="new-bind" select="$model//xforms:bind[@id = $current-bind-id]"/>
            <xforms:action context="$new-bind">
                <!-- Set built-in type if needed -->
                <xforms:insert if="$instance/builtin-type != ''" context="$new-bind"
                               origin="xxforms:attribute('type', concat(if ($instance/required = 'true' and not($instance/builtin-type = ('listItem', 'listItems', 'dayTimeDuration', 'yearMonthDuration', 'email', 'card-number'))) then 'xs:' else 'xforms:', $instance/builtin-type))"/>

                <!-- Set schema type if needed -->
                <!-- TODO: Handle namespace and prefix for namespace -->
                <xforms:insert if="$instance/schema-type != ''" context="$new-bind"
                               origin="xxforms:attribute('type', $instance/schema-type)"/>

                <!-- Set required -->
                <xforms:insert if="$instance/required = 'true'" context="$new-bind"
                               origin="xxforms:attribute('required', 'true()')"/>
                <xforms:delete if="$instance/required = 'false'" context="$new-bind"
                               nodeset="@required"/>

                <!-- Set constraint -->
                <xforms:insert if="normalize-space($instance/constraint) != ''" context="$new-bind"
                               origin="xxforms:attribute('constraint', normalize-space($instance/constraint))"/>
                <xforms:delete if="normalize-space($instance/constraint) = ''" context="$new-bind"
                               nodeset="@constraint"/>

                <!-- Set relevance -->
                <xforms:insert if="normalize-space($instance/relevant) != ''" context="$new-bind"
                               origin="xxforms:attribute('relevant', normalize-space($instance/relevant))"/>
                <xforms:delete if="normalize-space($instance/relevant) = ''" context="$new-bind"
                               nodeset="@relevant"/>

                <!-- Set readonly -->
                <xforms:insert if="normalize-space($instance/readonly) != ''" context="$new-bind"
                               origin="xxforms:attribute('readonly', normalize-space($instance/readonly))"/>
                <xforms:delete if="normalize-space($instance/readonly) = ''" context="$new-bind"
                               nodeset="@readonly"/>

                <!-- Set default value if needed -->
                <xforms:insert if="normalize-space($instance/default) != ''" context="$new-bind"
                               origin="xxforms:attribute('xxforms:default', normalize-space($instance/default))"/>
                <xforms:delete if="normalize-space($instance/default) = ''" context="$new-bind"
                               nodeset="@xxforms:default"/>

                <!-- Set calculated value if needed -->
                <xforms:insert if="normalize-space($instance/calculate) != ''" context="$new-bind"
                               origin="xxforms:attribute('calculate', normalize-space($instance/calculate))"/>
                <xforms:delete if="normalize-space($instance/calculate) = ''" context="$new-bind"
                               nodeset="@calculate"/>
            </xforms:action>

            <!-- TODO: constraints -->

        </xforms:action>
    </xforms:action>

    <!-- When the dialog opens, get type information from the form -->
    <xforms:action ev:event="xxforms-dialog-open">
        <xxforms:variable name="instance" select="instance('fb-validation-editor-instance')"/>
        <xxforms:variable name="current-control-resource" select="$current-resources/*[name() = $current-control-name]"/>
        <xxforms:variable name="current-bind-id" select="concat($current-control-name, '-bind')"/>
        <xxforms:variable name="current-bind" select="$model//xforms:bind[@id = $current-bind-id]"/>

        <!-- Copy alert -->
        <xforms:setvalue ref="$instance/alert" value="$current-control-resource/alert"/>

        <!-- Copy bind information -->

        <!-- Set string type if there is no type specified at all -->
        <xforms:setvalue if="not($current-bind/@type)" ref="$instance/builtin-type">string</xforms:setvalue>
        <xforms:setvalue ref="$instance/schema-type"/>
        <xforms:setvalue ref="$instance/required">false</xforms:setvalue>
        <xforms:setvalue ref="$instance/constraint" value="$current-bind/@constraint"/>
        <xforms:setvalue ref="$instance/relevant" value="$current-bind/@relevant"/>
        <xforms:setvalue ref="$instance/readonly" value="$current-bind/@readonly"/>

        <!-- Set type information if there is a type specified -->
        <xforms:action if="$current-bind/@type">
            <xxforms:variable name="is-builtin-type" select="starts-with($current-bind/@type, 'xs:') or starts-with($current-bind/@type, 'xforms:')"/>
            <xforms:setvalue if="$is-builtin-type" ref="$instance/builtin-type" value="substring-after($current-bind/@type, ':')"/>
            <!-- TODO: Handle namespace and prefix for namespace -->
            <xforms:setvalue if="not($is-builtin-type)"
                             ref="$instance/schema-type" value="$current-bind/@type"/>
            <xforms:setvalue ref="$instance/required" value="starts-with($current-bind/@type, 'xs:')"/>
        </xforms:action>

        <!-- Set default -->
        <xforms:setvalue ref="$instance/default" value="$current-bind/@xxforms:default"/>

        <!-- Set calculate -->
        <xforms:setvalue ref="$instance/calculate" value="$current-bind/@calculate"/>
    </xforms:action>

    <xforms:model id="fb-validation-model">
        <xforms:instance id="fb-validation-editor-instance">
            <validation>
                <builtin-type/>
                <required>false</required><!-- TODO XPath expression as well? -->

                <constraint/>
                <relevant/>
                <readonly/>

                <default/>
                <calculate/>
                <schema-type/>
                <alert/>

                <save-trigger/>
            </validation>
        </xforms:instance>

        <!-- Enable/disable trigger -->
        <xforms:setvalue ev:event="xxforms-invalid" ev:observer="fb-validation-editor-instance" ref="save-trigger">disabled</xforms:setvalue>
        <xforms:setvalue ev:event="xxforms-valid" ev:observer="fb-validation-editor-instance" ref="save-trigger">enabled</xforms:setvalue>

        <xforms:bind nodeset="instance('fb-validation-editor-instance')">
            <xforms:bind nodeset="required" readonly="../schema-type != ''"/>
            <xforms:bind nodeset="relevant | readonly | constraint | default | calculate" type="xxforms:xpath2" required="false()"/>
            <xforms:bind nodeset="save-trigger" readonly=". = 'disabled'"/>
        </xforms:bind>

        <!-- TODO: i18n -->
        <!-- TODO: more user-friendly labels for common types -->
        <xforms:instance id="fb-validation-types-instance" xxforms:readonly="true">
            <choices>
                <choices>
                    <label>Common Types</label>
                    <type allow-empty="true">string</type>
                    <type>float</type>
                    <type>double</type>
                    <type>decimal</type>
                    <type>integer</type>
                    <type>dateTime</type>
                    <type>time</type>
                    <type>date</type>
                    <type>boolean</type>
                    <type>anyURI</type>
                    <type>email</type>
                </choices>
                <choices>
                    <label>String Types</label>
                    <type allow-empty="true">string</type>
                    <type allow-empty="true">normalizedString</type>
                    <type>token</type>
                    <type>language</type>
                    <type>Name</type>
                    <type>NCName</type>
                    <type>ID</type>
                    <type>IDREF</type>
                    <type>IDREFS</type>
                    <type>ENTITY</type>
                    <type>ENTITIES</type>
                    <type>NMTOKEN</type>
                    <type>NMTOKENS</type>
                </choices>
                <choices>
                    <label>Number Types</label>
                    <type>float</type>
                    <type>double</type>
                    <type>decimal</type>
                    <type>integer</type>
                    <type>long</type>
                    <type>int</type>
                    <type>short</type>
                    <type>byte</type>
                    <type>positiveInteger</type>
                    <type>nonPositiveInteger</type>
                    <type>negativeInteger</type>
                    <type>nonNegativeInteger</type>
                    <type>unsignedLong</type>
                    <type>unsignedInt</type>
                    <type>unsignedShort</type>
                    <type>unsignedByte</type>
                </choices>
                <choices>
                    <label>Time Types</label>
                    <type>duration</type>
                    <type>dateTime</type>
                    <type>time</type>
                    <type>date</type>
                    <type>gYearMonth</type>
                    <type>gYear</type>
                    <type>gMonthDay</type>
                    <type>gDay</type>
                    <type>gMonth</type>
                </choices>
                <choices>
                    <label>Other Types</label>
                    <type>boolean</type>
                    <!-- Not 100% sure if these two types allow empty content -->
                    <type allow-empty="true">hexBinary</type>
                    <type allow-empty="true">base64Binary</type>
                    <type>anyURI</type>
                    <type>QName</type>
                    <type>NOTATION</type>
                </choices>
            </choices>
        </xforms:instance>
    </xforms:model>

</xxforms:dialog>
